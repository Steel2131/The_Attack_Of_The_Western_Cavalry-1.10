#textdomain wesnoth-taotwc
[scenario]
    id=16c_Silver_Fort
    name= _ ""
    map_data="{~add-ons/The_Attack_Of_The_Western_Cavalry/maps/16c_Silver_Fort.map}"
    next_scenario=17c_The_Tunnels
#ifdef EASY
    turns=30
#endif
#ifdef HARD
    turns=35
#endif

    {DEFAULT_SCHEDULE_AFTERNOON}
    {~add-ons/The_Attack_Of_The_Western_Cavalry/utils/summarise.cfg}




    [story]
        [part]
            story= _ "After escaping the frozen north, the little host started for a fortress in the near, to reload their supplies."
            background=story/frozen.jpg
            show_title=yes
        [/part]
        [part]
            story= _ "But Aethyr and his men trusted their new leader, and followed her..."
            background=story/frozen.jpg
            show_title=yes
        [/part]
		{TAOTWC_TRAVEL_16c}
    [/story]



    #########
    ##SIDES##
    #########
    [side]
#ifdef EASY
        gold=220
#endif
#ifdef HARD
        gold=200
#endif
        type=Western Knight
        id=Aethyr
        name= _ "Aethyr"
        unrenamable=yes
        profile="portraits/aethyr.png"
        side=1
        canrecruit=yes
        controller=human
        {FLAG_CAVALRY}
        recruit=Western Horseman,Western Cavalryman,Western Junior Commander,Prisoner2,Skeleton2,Skeleton Archer2,Walking Corpse2,Ghoul2,Ghost2,Skeleton Rider2,Spearman,Bowman,Fencer
        team_name=Westerns
        user_team_name=_"Western Cavalry"
        fog=yes
        shroud=yes
    [/side]
    [side]
#ifdef EASY
        gold=250
#endif
#ifdef HARD
        gold=225
#endif
        type=TAOTWC_Lord
        id=Derraent
        name= _ "Lord Derraent"
        unrenamable=yes
        side=2
        canrecruit=yes
        controller=ai
        {FLAG_LOYALISTS}
        recruit=Swordsman,Longbowman,Dragoon,Spearman,Bowman,Duelist,Fencer,Sergeant,Lieutenant,Cavalryman,TAOTWC_Fighter
        team_name=Westerns
        user_team_name=_"Defenders of Silver Fort"
        fog=yes
        shroud=yes
        share_maps=no
        share_view=no
        [ai]
            #[avoid]
            #    terrain=Ww,Wwg^Bw/r,Ww^Bw/
            #[/avoid]
            aggression=-2.0
            {TARGET_TO protect_location x,y=39,29 (
                value=100
                protect_radius=3
            )}
        [/ai]
    [/side]
    [side]
#ifdef EASY
        gold=300
#endif
#ifdef HARD
        gold=350
#endif
        type=Rider Of Apocalypse
        id=Gregor
        name= _ "Gregor"
        unrenamable=yes
        side=3
        canrecruit=yes
        controller=ai
        {FLAG_CAVALRY}
        recruit=Western Horseman,Western Cavalryman,Western Junior Commander,Swamp Walker,Swamp Fighter,Swamp General,Swamp Warrior
        team_name=Enemy
        user_team_name=_"Imperials"
        fog=yes
        shroud=yes
        [ai]
            aggression=0.8
        [/ai]
        [ai]
            {TARGET_TO target side=2 (value=100)}
            {TARGET_TO target side=1 (value=90)}
        [/ai]
    [/side]
    [side]
#ifdef EASY
        gold=250
#endif
#ifdef HARD
        gold=300
#endif
        type=Dwarvish Lord
        id=Pelalis
        name= _ "Pelalis"
        unrenamable=yes
        side=4
        canrecruit=yes
        controller=ai
        {FLAG_KNALGAN}
        recruit=Gryphon Rider,Dwarvish Fighter2,Dwarvish Scout,Dwarvish Thunderer
        team_name=Enemy
        user_team_name=_"Dwarves"
        fog=yes
        shroud=yes
        [ai]
            aggression=0.8
        [/ai]
        [ai]
            {TARGET_TO target side=2 (value=100)}
            {TARGET_TO target side=1 (value=90)}
        [/ai]
    [/side]
    [side]
#ifdef EASY
        gold=300
#endif
#ifdef HARD
        gold=330
#endif
        type=Orcish Sovereign
        id=Punok
        name= _ "Punok"
        unrenamable=yes
        side=5
        canrecruit=yes
        controller=ai
        {FLAG_ORCISH}
        recruit=Orcish Warrior,Orcish Crossbowman,Orcish Grunt,Orcish Archer,Nightstalker,Ocean Orc
        team_name=Enemy
        user_team_name=_"Orcs"
        fog=yes
        shroud=yes
        [ai]
            aggression=0.8
        [/ai]
        [ai]
            {TARGET_TO target side=2 (value=100)}
            {TARGET_TO target side=1 (value=90)}
        [/ai]
    [/side]
    [side]
#ifdef EASY
        gold=250
#endif
#ifdef HARD
        gold=320
#endif
        type=Western Commander
        id=Worgon
        name= _ "Worgon"
        unrenamable=yes
        side=6
        canrecruit=yes
        controller=ai
        {FLAG_CAVALRY}
        recruit=Western Horseman,Western Cavalryman,Western Junior Commander
        team_name=Enemy
        user_team_name=_"Western Kingdom"
        fog=yes
        shroud=yes
        [ai]
            aggression=0.8
        [/ai]
        [ai]
            {TARGET_TO target side=2 (value=100)}
            {TARGET_TO target side=1 (value=90)}
        [/ai]
    [/side]
    [side]
#ifdef EASY
        gold=270
#endif
#ifdef HARD
        gold=310
#endif
        type=General Of Death
        id=Mark
        name= _ "Mark"
        unrenamable=yes
        side=7
        canrecruit=yes
        controller=ai
        {FLAG_CAVALRY}
        recruit=Western Knight,Western Dragoon,Western Commander,Swamp Walker
        team_name=Enemy
        user_team_name=_"Imperials"
        fog=yes
        shroud=yes
        [ai]
            aggression=0.8
        [/ai]
        [ai]
            {TARGET_TO target side=2 (value=100)}
            {TARGET_TO target side=1 (value=90)}
        [/ai]
    [/side]

















    #{EXTRA_NECKLACE 1 1 necklace_1}
    #{POTION_MORAL 20 1 pot_1}
    #{POTION_MORAL 14 14 pot_2}
    #{POTION_MORAL 38 18 pot_3}
    #{ARMOR_STEEL 10 36 stell_arm_1}
    {ANIMATED_FLAG 39 29}


    {CORPSES (
        {NOT id=Aethyr}
        {NOT id=Morgan}
        {NOT id=Warwick}
        {NOT id=Leogwyn}
        {NOT id=Garak}
        {NOT id=Challa}
        {NOT id=Hrothgar}
        {NOT id=Berg}
        {NOT id=Orkon}
    )}



    [label]
        x,y=32,24
        text= _ "Detonator"
    [/label]
    [label]
        x,y=32,27
        text= _ "Headquarter's Building"
    [/label]
    [label]
        x,y=22,17
        text= _ "Northwestern Bastalion"
    [/label]
    [label]
        x,y=23,35
        text= _ "Southwestern Bastalion"
    [/label]
    [label]
        x,y=41,17
        text= _ "Northeastern Bastalion"
    [/label]
    [label]
        x,y=59,27
        text= _ "Eastern Bastalion"
    [/label]
    [label]
        x,y=57,37
        text= _ "Southeastern Bastalion"
    [/label]

    [label]
        x,y=41,36
        text= _ "Southern Wall"
    [/label]
    [label]
        x,y=24,27
        text= _ "Western Wall"
    [/label]
    [label]
        x,y=32,15
        text= _ "Northern Wall"
    [/label]
    [label]
        x,y=42,26
        text= _ "Gate"
    [/label]
    [label]
        x,y=57,33
        text= _ "Eastern Wall"
    [/label]


    [item]
        x,y=32,24
        image=items/anvil.png
    [/item]






    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                description= _ "Defend the Flag"
                condition=win
            [/objective]
            [objective]
                description= _ "Fall of the Flag"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Aethyr"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Princess Challa"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Leogwyn"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Warwick"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Garak"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Tal-M'rgan"
                condition=lose
            [/objective]
        [/objectives]
        [set_menu_item]
            id=menu_item_1
            description= _ "None"
            [show_if]
                # Hmm...if I put here an impossible matching, then
                # it'll be never showed again, no? :)
                [have_unit]
                    side=1
                    x=$x1
                    y=$y1
                    [not]
                    [filter_wml]
                        [variables]
                            oagenoegno=oneagoenagccknie
                        [/variables]
                    [/filter_wml]
                    [/not]    
                [/have_unit]
            [/show_if]
            [command]
            [/command]
        [/set_menu_item]




        # FORT GUARD PLACING #

        {GUARDIAN_ID_UNIT 2 (Halberdier) 60 16 Gateguard1}
        {GUARDIAN_ID_UNIT 2 (Halberdier) 62 17 Gateguard2}
        {GUARDIAN_ID_UNIT 2 (Pikeman) 42 24 Gateguard3}

        [store_locations]
            terrain=Cha
            variable=foot_solds
        [/store_locations]
        {FOREACH foot_solds i}
            {RANDOM 1..4}
                [switch]
                    variable=random
                    [case]
                        value=1
                    [/case]
                    [else]
                        {RANDOM (Spearman,Bowman,Fencer,Heavy Infantryman2)}

                        {GUARDIAN_UNIT 2 ($random) $foot_solds[$i].x $foot_solds[$i].y}
                    [/else]
                [/switch]
        {NEXT i}

        [store_locations]
            terrain=Ket
            variable=elit_solds
        [/store_locations]
        {FOREACH elit_solds i}
            {RANDOM 1..2}
            [if]
                [variable]
                    name=random
                    numerical_equals=1
                [/variable]
                [then]
                    {RANDOM (Longbowman,Pikeman,Swordsman,Heavy Infantry Lieutenant,Shock Trooper)}
                    {GUARDIAN_UNIT 2 ($random) $elit_solds[$i].x $elit_solds[$i].y}
                [/then]
            [/if]
        {NEXT i}

        [store_locations]
            terrain=Coa
            variable=elit_solds
        [/store_locations]
        {FOREACH elit_solds i}
            {RANDOM 1..3}
            [if]
                [variable]
                    name=random
                    numerical_not_equals=1
                [/variable]
                [then]
                    {RANDOM (Pikeman,Longbowman,Swordsman)}
                    {GUARDIAN_UNIT 2 ($random) $elit_solds[$i].x $elit_solds[$i].y}
                [/then]
            [/if]
        {NEXT i}

        [store_locations]
            terrain=Koa
            [not]
                x,y=60,16
            [/not]
            [not]
                x,y=62,17
            [/not]
            variable=super_solds
        [/store_locations]
        {FOREACH super_solds i}
            {RANDOM 1..2}
            [if]
                [variable]
                    name=random
                    numerical_equals=1
                [/variable]
                [then]
                    {RANDOM (Halberdier,Royal Guard,Master Bowman)}
                    {GUARDIAN_UNIT 2 ($random) $super_solds[$i].x $super_solds[$i].y}
                [/then]
            [/if]
        {NEXT i}







    [/event]


    [event]
        name=start
        [recall]
            id=Challa
        [/recall]
        [recall]
            id=Warwick
        [/recall]
        [recall]
            id=Leogwyn
        [/recall]
        [recall]
            id=Morgan
        [/recall]
        [recall]
            id=Garak
        [/recall]

        [message]
            speaker=Garak
            message= _ "So where are we going?"
        [/message]
        [message]
            speaker=Challa
            message= _ "This the no-man's land, with a fortress of ours in the center. I think we couldn't be at any more dangerous place than this terrain, even if we wanted to. This is the line where all the fronts meet, and they all want to capture the fort."
        [/message]
        [message]
            speaker=Aethyr
            message= _ "Meaning you have other commands, not just saving us...for example like saving the fort?"
        [/message]
        [message]
            speaker=Challa
            message= _ "Nay, I have no command for that, but I have intention to do so."
        [/message]
        [message]
            speaker=Warwick
            message= _ "Great folks, I have a large amount of experience on that! The key is not to lose any bastions, let the walls break if it can't hold on, let 'em into the field of the fort, then counter-attack 'em, and let the soldiers sleep as much as they want..."
        [/message]
        [message]
            speaker=Leogwyn
            message= _ "Easy up there..."
        [/message]
        [message]
            speaker=Warwick
            message= _ "*<i>chuckles</i>* Sorry..."
        [/message]
        [message]
            speaker=Aethyr
            message= _ "Then gallop into that fort!"
        [/message]
        [remove_shroud]
            side=1
            terrain=Re
        [/remove_shroud]
        [modify_side]
            side=1
            fog=no
        [/modify_side]
        {REDRAW_SIDE 1}
        {MOVE_UNIT id=Aethyr 62 14}
        {REDRAW_SIDES 2}
        {MOVE_UNIT id=Challa 63 15}
        {REDRAW_SIDES 2}
        {MOVE_UNIT id=Warwick 61 14}
        {REDRAW_SIDES 2}
        {MOVE_UNIT id=Garak 63 14}
        {REDRAW_SIDES 2}
        {MOVE_UNIT id=Leogwyn 64 14}
        {REDRAW_SIDES 2}
        [message]
            speaker=Morgan
            message= _ "I've got a baaaaad feeling about this..."
        [/message]
        {MOVE_UNIT id=Morgan 60 14}

        {REDRAW_SIDES 2}
        
        [message]
            speaker=Gateguard1
            message= _ "Stop you there! What do you want?!"
        [/message]
        [message]
            speaker=Aethyr
            message= _ "To camp here by the gates, and look at you all day...what do you think, what do we want? Small-brained, unprofessioned...*<i>Challa kicks his head</i>* OUGH!"
        [/message]
        [message]
            speaker=Challa
            message= _ "*<i>hisses</i>* Are you that stupid to offend them? They are comrades! *<i>to the soldiers</i>* I am Challa, princess of Wesnoth, we are looking for shelter, and also willing to have some words with the commander of the fort."
        [/message]
        [message]
            speaker=Gateguard1
            message= _ "As you wish My Lady, Lord Derraent will probably meet with you, but I must warn you, the fort is on the verge of being under siege, probably it will be in a few hours."
        [/message]
        [message]
            speaker=Gateguard2
            message= _ "Follow me to the bridge!"
        [/message]
        [remove_shroud]
            side=1
            terrain=Ww^Bw/
        [/remove_shroud]
        [modify_side]
            side=2
            share_maps=yes
            share_view=yes
        [/modify_side]
        {MOVE_UNIT id=Gateguard2 43 24}
        [message]
            speaker=Gateguard3
            message= _ "What's up mate? Why did ya leave yer outpost?"
        [/message]
        [message]
            speaker=Gateguard2
            message= _ "Got the princess here, hell knows why. But I think we'd better let 'em through, if we don't wanna get into trouble..."
        [/message]
        [message]
            speaker=Gateguard3
            message= _ "Accepted, but mark my words, you play with yer head, not mine. They can pass."
        [/message]
        {MOVE_UNIT id=Gateguard2 31 32}
        {TELEPORT_UNIT id=Aethyr 31 29}
        {TELEPORT_UNIT id=Challa 32 29}
        {TELEPORT_UNIT id=Warwick 33 29}
        {TELEPORT_UNIT id=Garak 31 30}
        {TELEPORT_UNIT id=Leogwyn 33 30}
        {TELEPORT_UNIT id=Morgan 32 30}

        [message]
            speaker=Derraent
            message= _ "Welcome in Silver Fort princess, and company. I am sorry, but we probably will not be able to provide the comfort you might need, but you must understand that..."
        [/message]
        [message]
            speaker=Morgan
            message= _ "No need to worry about that mate, we came to save this barn *<i>grinning</i>*...fortress, sorry, fortress, you call it."
        [/message]
        [message]
            speaker=Challa
            message= _ "Maybe he said it a bit roughly, but yes, that's the point."
        [/message]
        [message]
            speaker=Derraent
            message= _ "Good, every help is thanked now. This wave of siege is going to be a big one, because everyone is here, their only aim is to break this last fort that blocks the way to Weldyn.
Can you see the flag out there? That's the hope of my men, so if it falls, they fall, we fall."
        [/message]
        [message]
            speaker=Derraent
            message= _ "I don't know how much accostumed you are to sieges and fights inside forts, but since the enemy will be attacking at full power, it might help if you use these hints: never ever lose the bastalions, and use them as centres of battles. Always keep your enemies off the wall, but if a wall is breakening, don't hesitate to blow it up, and let them deeper in, where you can use the lain traps."
        [/message]
        {MOVE_UNIT id=Aethyr 37 22}
        [terrain]
            x,y=37,22
            terrain=Ke
        [/terrain]
        [terrain]
            x,y=37,21
            terrain=Ce
        [/terrain]
        [terrain]
            x,y=37,23
            terrain=Ce
        [/terrain]
        [terrain]
            x,y=36,21
            terrain=Ce
        [/terrain]
        [terrain]
            x,y=36,22
            terrain=Ce
        [/terrain]
        [terrain]
            x,y=38,21
            terrain=Ce
        [/terrain]
        [terrain]
            x,y=38,22
            terrain=Ce
        [/terrain]


        [teleport]
            [filter]
                id=Gateguard2
            [/filter]
            x,y=62,17
        [/teleport]
        [modify_side]
            side=1
            fog=yes
        [/modify_side]

    [/event]






    [event]
        name=recruit
        first_time_only=no
        [filter]
            side=1
        [/filter]
        [message]
            x,y=$x1,$y1
            message= _ "Sir, at what time should I fight?"
            [option]
                message= _ "Fight at daylight!"
                [command]
                    {STORE_UNIT x,y=$x1,$y1 daylight yes}
                    {VARIABLE daylight.variables.fighting_time day}
                    [unstore_unit]
                        variable=daylight
                    [/unstore_unit]
                [/command]
            [/option]
            [option]
                message= _ "Be the warrior of the night!"
                [command]
                    {STORE_UNIT x,y=$x1,$y1 darkness yes}
                    {VARIABLE daylight.variables.fighting_time night}
                    [unstore_unit]
                        variable=darkness
                    [/unstore_unit]
                [/command]
            [/option]
        [/message]
    [/event]
    [event]
        name=recall
        first_time_only=no
        [message]
            x,y=$x1,$y1
            message= _ "Sir, at what time should I fight?"
            [option]
                message= _ "Fight at daylight!"
                [command]
                    {STORE_UNIT x,y=$x1,$y1 daylight yes}
                    {VARIABLE daylight.variables.fighting_time day}
                    [unstore_unit]
                        variable=daylight
                    [/unstore_unit]
                [/command]
            [/option]
            [option]
                message= _ "Be the warrior of the night!"
                [command]
                    {STORE_UNIT x,y=$x1,$y1 darkness yes}
                    {VARIABLE daylight.variables.fighting_time night}
                    [unstore_unit]
                        variable=darkness
                    [/unstore_unit]
                [/command]
            [/option]
        [/message]
    [/event]


    ## SLEEPING ##
    [event]
        name=new turn
        first_time_only=no
        [filter]
            side=1
            [filter_location]
                time_of_day_id=dawn
            [/filter_location]
        [/filter]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Time to have some rest for the swords in the dark, and wake the fighters of daylight!"
        [/message]

        {FOREACH nightsleep i}
            #Add some hitpoints before, but only if unit did not have his max hitpoints
            {VARIABLE hitpointok $nightsleep[$i].max_hitpoints}
            {VARIABLE_OP hitpointok sub $nightsleep[$i].hitpoints}
            [if]
                [variable]
                    name=hitpointok
                    less_than=8
                [/variable]
                [then]
                    {VARIABLE nightsleep[$i].hitpoints $nightsleep[$i].max_hitpoints}
                [/then]
                [else]
                    {VARIABLE_OP nightsleep[$i].hitpoints add 8}
                [/else]
            [/if]

            [unstore_unit]
                variable=nightsleep[$i]
            [/unstore_unit]
            {CLEAR_VARIABLE hitpointok}
        {NEXT i}

        {STORE_UNIT (side=1
{NOT id=Aethyr}
{NOT id=Leogwyn}
{NOT id=Warwick}
{NOT id=Morgan}
{NOT id=Challa}) daysleep yes}
#and the other leaders!

        {FOREACH sleeping_check i}
            [if]
                [variable]
                    name=daysleep[$i].variables.fighting_time
                    equals=day
                [/variable]
                [then]
                    [unstore_unit]
                        variable=daysleep[$i]
                    [/unstore_unit]
                [/then]
            [/if]
        {NEXT i}
    [/event]
                    
    [event]
        name=new turn
        first_time_only=no
        [filter]
            side=1
            [filter_location]
                time_of_day_id=dusk
            [/filter_location]
        [/filter]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Time for the mortals to have some sleep, and let the beasts of the Night continue the battle!"
        [/message]

        {FOREACH daysleep i}
            #Add some hitpoints before, but only if unit did not have his max hitpoints
            {VARIABLE hitpointok $daysleep[$i].max_hitpoints}
            {VARIABLE_OP hitpointok sub $daysleep[$i].hitpoints}
            [if]
                [variable]
                    name=hitpointok
                    less_than=8
                [/variable]
                [then]
                    {VARIABLE daysleep[$i].hitpoints $daysleep[$i].max_hitpoints}
                [/then]
                [else]
                    {VARIABLE_OP daysleep[$i].hitpoints add 8}
                [/else]
            [/if]

            [unstore_unit]
                variable=daysleep[$i]
            [/unstore_unit]
            {CLEAR_VARIABLE hitpointok}
        {NEXT i}

        {STORE_UNIT (side=1
{NOT id=Aethyr}
{NOT id=Leogwyn}
{NOT id=Warwick}
{NOT id=Morgan}
{NOT id=Challa}) nightsleep yes}
        {FOREACH nightsleep i}
            [if]
                [variable]
                    name=daysleep[$i].variables.fighting_time
                    equals=night
                [/variable]
                [then]
                    [unstore_unit]
                        variable=daysleep[$i]
                    [/unstore_unit]
                [/then]
            [/if]
        {NEXT i}
    [/event]










    # TRAPS AND BLOWING #
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=32,24
            side=1
        [/filter]
        [message]
            speaker=unit
            message= _ "Where should I trigger the explosives?"
            [show_if]
                [variable]
                    name=south_wall_blowed
                    not_equals=yes
                [/variable]
                [or]
                    [variable]
                        name=west_wall_blowed
                        not_equals=yes
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=north_wall_blowed
                        not_equals=yes
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=east_wall_blowed
                        not_equals=yes
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=gates_wall_blowed
                        not_equals=yes
                    [/variable]  
                [/or]
            [/show_if]
            [option]
                message= _ "Nowhere."
                [command]
                    [allow_undo]
                    [/allow_undo]
                [/command]
            [/option]
            [option]
                message= _ "Blow up the southern wall!"
                [show_if]
                    [variable]
                        name=south_wall_blowed
                        not_equals=yes
                    [/variable]
                [/show_if]
                [command]
                    {VARIABLE south_wall_blowed yes}
                    {SCROLL_TO 40 36}
                    {THUNDER (

                        {CORPSE_EFFECT (x=27-55
                                        y=35-37)}

                            [store_locations]
                                    x=27-55
                                    y=36

                                variable=castles
                            [/store_locations]
                            {FOREACH castles i}
                                {RANDOM Ww,Chw,Ds}
                                [terrain]
                                    x=$castles[$i].x
                                    y=$castles[$i].y
                                    terrain=$random
                                [/terrain]
                                {REDRAW}
                            {NEXT i}
                            [store_locations]
                                    x=27-55
                                    y=35

                                variable=castles
                            [/store_locations]
                            {FOREACH castles i}
                                {RANDOM Ww,Ds}
                                [terrain]
                                    x=$castles[$i].x
                                    y=$castles[$i].y
                                    terrain=$random
                                [/terrain]
                                {REDRAW}
                            {NEXT i}
                            )}
                [/command]
            [/option]
            [option]
                [show_if]
                    [variable]
                        name=west_wall_blowed
                        not_equals=yes
                    [/variable]
                [/show_if]
                message= _ "Blow up the western wall!"
                [command]
                    {VARIABLE west_wall_blowed yes}
                    {SCROLL_TO 24 27}
                    {THUNDER (

                        {CORPSE_EFFECT (x=23-25
                                        y=23-32)}

                            [store_locations]
                                    x=24
                                    y=23-32

                                variable=castles
                            [/store_locations]
                            {FOREACH castles i}
                                {RANDOM Ww,Chw,Ds}
                                [terrain]
                                    x=$castles[$i].x
                                    y=$castles[$i].y
                                    terrain=$random
                                [/terrain]
                                {REDRAW}
                            {NEXT i}
                            [store_locations]
                                    x=25
                                    y=23-32

                                variable=castles
                            [/store_locations]
                            {FOREACH castles i}
                                {RANDOM Ww,Ds}
                                [terrain]
                                    x=$castles[$i].x
                                    y=$castles[$i].y
                                    terrain=$random
                                [/terrain]
                                {REDRAW}
                            {NEXT i}
                            )}
                [/command]
            [/option]
            [option]
                message= _ "Blow up the northern wall!"
                [show_if]
                    [variable]
                        name=north_wall_blowed
                        not_equals=yes
                    [/variable]
                [/show_if]
                [command]
                    {VARIABLE north_wall_blowed yes}
                    {SCROLL_TO 31 16}
                    {THUNDER (

                        {CORPSE_EFFECT (x=26-37
                                        y=14-16)}

                            [store_locations]
                                    x=26-37
                                    y=15

                                variable=castles
                            [/store_locations]
                            {FOREACH castles i}
                                {RANDOM Ww,Chw,Ds}
                                [terrain]
                                    x=$castles[$i].x
                                    y=$castles[$i].y
                                    terrain=$random
                                [/terrain]
                                {REDRAW}
                            {NEXT i}
                            [store_locations]
                                    x=26-37
                                    y=16

                                variable=castles
                            [/store_locations]
                            {FOREACH castles i}
                                {RANDOM Ww,Ds}
                                [terrain]
                                    x=$castles[$i].x
                                    y=$castles[$i].y
                                    terrain=$random
                                [/terrain]
                                {REDRAW}
                            {NEXT i}
                            )}
                [/command]
            [/option]
            [option]
                message= _ "Blow up the eastern wall!"
                [show_if]
                    [variable]
                        name=east_wall_blowed
                        not_equals=yes
                    [/variable]
                [/show_if]
                [command]
                    {VARIABLE east_wall_blowed yes}
                    {SCROLL_TO 57 33}
                    {THUNDER (

                        {CORPSE_EFFECT (x=56-58
                                        y=30-36)}

                            [store_locations]
                                    x=57
                                    y=30-36

                                variable=castles
                            [/store_locations]
                            {FOREACH castles i}
                                {RANDOM Ww,Chw,Ds}
                                [terrain]
                                    x=$castles[$i].x
                                    y=$castles[$i].y
                                    terrain=$random
                                [/terrain]
                                {REDRAW}
                            {NEXT i}
                            [store_locations]
                                    x=56
                                    y=30-36

                                variable=castles
                            [/store_locations]
                            {FOREACH castles i}
                                {RANDOM Ww,Ds}
                                [terrain]
                                    x=$castles[$i].x
                                    y=$castles[$i].y
                                    terrain=$random
                                [/terrain]
                                {REDRAW}
                            {NEXT i}
                            )}
                [/command]
            [/option]
            [option]
                message= _ "Blow up the gate and its walls!"
                [show_if]
                    [variable]
                        name=gates_wall_blowed
                        not_equals=yes
                    [/variable]
                [/show_if]
                [command]
                    {VARIABLE gates_wall_blowed yes}
                    {SCROLL_TO 43 27}
                    {THUNDER (

                        {CORPSE_EFFECT (x=41-43
                                        y=20-26)}


                            [store_locations]
                                    x=42
                                    y=20-26

                                variable=castles
                            [/store_locations]
                            {FOREACH castles i}
                                {RANDOM Ww,Chw,Ds}
                                [terrain]
                                    x=$castles[$i].x
                                    y=$castles[$i].y
                                    terrain=$random
                                [/terrain]
                                {REDRAW}
                            {NEXT i}
                            [store_locations]
                                    x=41
                                    y=20-26

                                variable=castles
                            [/store_locations]
                            {FOREACH castles i}
                                {RANDOM Ww,Ds}
                                [terrain]
                                    x=$castles[$i].x
                                    y=$castles[$i].y
                                    terrain=$random
                                [/terrain]
                                {REDRAW}
                            {NEXT i}



                        {CORPSE_EFFECT (x=43-55
                                        y=25-27)}


                            [store_locations]
                                    x=43-55
                                    y=26

                                variable=castles
                            [/store_locations]
                            {FOREACH castles i}
                                {RANDOM Ww,Chw,Ds}
                                [terrain]
                                    x=$castles[$i].x
                                    y=$castles[$i].y
                                    terrain=$random
                                [/terrain]
                                {REDRAW}
                            {NEXT i}
                            [store_locations]
                                    x=43-55
                                    y=27

                                variable=castles
                            [/store_locations]
                            {FOREACH castles i}
                                {RANDOM Ww,Ds}
                                [terrain]
                                    x=$castles[$i].x
                                    y=$castles[$i].y
                                    terrain=$random
                                [/terrain]
                                {REDRAW}
                            {NEXT i}
                            )}
                [/command]
            [/option]
        [/message]
    [/event]







    ## VICTORY ##

#define VICTORY_EFFECT
    [message]
        speaker=Challa
        message= _ "Nice work soldiers, really nice! Now we showed them what Wesnoth is capable of!"
    [/message]
    [message]
        speaker=Warwick
        message= _ "*<i>bloody grin on his face</i>* Best fight I ever had!"
    [/message]
    [message]
        speaker=Morgan
        message= _ "*<i>touching two of his half-broken ribs</i>* Worst fight I ever had..."
    [/message]
    [message]
        speaker=Aethyr
        message= _ "We were lucky. What now?"
    [/message]
    [message]
        speaker=Derraent
        message= _ "Well, in the meantime a messeger got through the lines, and told me that the king has started to the north to expel Xanthos. We have commands to do the same on the Western Kingdom."
    [/message]
    [message]
        speaker=Challa
        message= _ "There is a cave to the east of this fort, called the Grifer Harblurst..."
    [/message]
    [message]
        speaker=Leogwyn
        message= _ "Meaning in the necromancer language, 'Place for Skeletons to Mourn?'"
    [/message]
    [message]
        speaker=Warwick
        message= _ "Exaclty. After the rebellion of those called 'Allies', the Wesnothian relic was hidden there, was it not?"
    [/message]
    [message]
        speaker=Challa
        message= _ "*<i>dismayed</i>* How do you know that?"
    [/message]
    [message]
        speaker=Warwick
        message= _ "I had to deliver it here. I was disawowed and put into prison just after that."
    [/message]
    [message]
        speaker=Aethyr
        message= _ "Then you mean, we have to get this relic?"
    [/message]
    [message]
        speaker=Derraent
        message= _ "Yes, we have a command to acquire it."
    [/message]
    [message]
        speaker=Aethyr
        message= _ "Then...? Why are we still here? Let's go!"
    [/message]
    [message]
        speaker=Challa
        message= _ "Ahm...we have a little problem with this one."
    [/message]
    [message]
        speaker=Aethyr
        message= _ "What problem?"
    [/message]
    [message]
        speaker=Derraent
        message= _ "The Griger Harblurst is guarded well, and only an undead can pass, no human, and none with knowledge of magic."
    [/message]
    [delay]
        time=600
    [/delay]
    [message]
        speaker=Morgan
        message= _ "Why...is...everyone..lookin' at me?"
    [/message]
    [message]
        speaker=Aethyr
        message= _ "Morgan, I need to ask one more favour from you..."
    [/message]
    [message]
        speaker=Morgan
        message= _ "NOOOO! I SHALL NEVER UNDEARTAKE IT! NO! NEVER, FIND SOMEONE ELSE!!!"
    [/message]



    [endlevel]
        result=victory
        carryover_report=no
        linger_mode=no
    [/endlevel]
#enddef

    [event]
        name=enemies defeated
        [message]
            speaker=Derraent
            message= _ "Excellent, and unexpected work gentlemen! I think we've beaten this siege off for a long time!"
        [/message]
        {VICTORY_EFFECT}
    [/event]
    [event]
        name=time over
        [message]
            side=3,4,5,6,7
            message= _ "We have to retreat now, but this fort is yet to be a graveyard, mark these words!"
        [/message]
        {VICTORY_EFFECT}
    [/event]





    # DEATHS #
    [event]
        name=last breath
        [filter]
            id=Derraent
        [/filter]
        [message]
            speaker=Derraent
            message= _ "The last outpost that held the fronts is broken! Wesnoth shall not withstand this..."
        [/message]
        {DEFEAT}
    [/event]
    [event]
        name=last breath
        [filter]
            id=Challa
        [/filter]
        [message]
            speaker=Challa
            message= _ "Ough..."
        [/message]
        [message]
            speaker=Aethyr
            message= _ "No...the king will behead us for this..."
        [/message]
        {DEFEAT}
    [/event]

#undef VICTORY_EFFECT
[/scenario]
